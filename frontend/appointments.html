<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Source+Serif+4:ital,wght@0,300;0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
        /* ===========================
           THEME PORT: AKS Hospital Executive Theme
           =========================== */
        :root {
            /* Palette from Admin Dashboard */
            --navy: #1a3236; 
            --teal: #2d7a75;
            --teal-dark: #1f5c58;
            --gold: #c5a059;
            
            /* Backgrounds */
            --bg-gradient: linear-gradient(135deg, #cfd8dc 0%, #eceff1 100%);
            --bg-card: #ffffff;
            
            /* Typography */
            --font-head: 'Playfair Display', serif;
            --font-body: 'Source Serif 4', serif;
            --text-main: #263238;
            --text-muted: #546e7a;

            /* Effects */
            --shadow-card: 0 4px 15px rgba(0,0,0,0.06);
            --radius: 12px;
            --input-bg: #f9fbfb;
            --input-border: #cfd8dc;
        }

        body { 
            font-family: var(--font-body); 
            background: var(--bg-gradient); 
            color: var(--text-main);
            margin: 0; 
            padding: 40px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container { 
            width: 100%;
            max-width: 500px; 
            background: var(--bg-card); 
            padding: 40px; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow-card); 
            /* Subtle top border accent like dashboard cards */
            border-top: 5px solid var(--navy); 
            position: relative;
        }

        h2 { 
            text-align: center; 
            font-family: var(--font-head);
            color: var(--navy); 
            margin-bottom: 30px; 
            font-weight: 700;
            font-size: 2.2rem;
            letter-spacing: -0.5px;
        }

        /* Patient Info Box - Styled like 'stat-card' from Dashboard */
        .patient-details-box { 
            background: var(--bg-card); 
            padding: 20px; 
            margin-bottom: 30px; 
            border-radius: var(--radius); 
            box-shadow: var(--shadow-card);
            border-left: 4px solid var(--teal); /* Matching stat-card accent */
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .patient-details-box h3 {
            margin: 0 0 10px 0;
            font-family: var(--font-head);
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 700;
            border-bottom: 1px dashed #eceff1;
            padding-bottom: 8px;
        }

        .patient-details-box p {
            margin: 5px 0;
            color: var(--navy);
            font-size: 1rem;
            font-family: var(--font-body);
        }
        
        .patient-details-box strong {
            color: var(--teal);
            font-weight: 600;
            margin-right: 5px;
        }

        /* Form Elements */
        .form-group { margin-bottom: 25px; }
        
        .form-group label { 
            display: block; 
            margin-bottom: 10px; 
            font-weight: 700; 
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase; /* Matching Dashboard Headers */
            letter-spacing: 0.5px;
        }
        
        /* Inputs matching Dashboard 'input, select' styles */
        .form-group input, 
        .form-group textarea { 
            width: 100%; 
            padding: 14px; 
            border: 1px solid var(--input-border); 
            border-radius: 8px; 
            box-sizing: border-box; 
            font-family: var(--font-body);
            font-size: 1rem;
            background: var(--input-bg);
            color: var(--text-main);
            transition: all 0.2s ease;
        }

        .form-group input:focus, 
        .form-group textarea:focus {
            border-color: var(--teal);
            background: #fff;
            outline: none;
            box-shadow: 0 0 0 4px rgba(45, 122, 117, 0.1); /* Teal Glow */
        }

        /* Button matching '.btn-primary' from Dashboard */
        button { 
            width: 100%; 
            padding: 12px 18px; 
            background-color: var(--teal); 
            border: none; 
            border-radius: 6px; 
            color: white; 
            font-family: var(--font-head); /* Playfair Display */
            font-size: 1rem; 
            font-weight: 700; 
            cursor: pointer; 
            transition: all 0.2s ease; 
            box-shadow: 0 4px 12px rgba(45, 122, 117, 0.3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }

        button:hover { 
            background-color: var(--teal-dark); 
            transform: translateY(-2px);
        }

        /* --- SELECT2 CUSTOMIZATION TO MATCH THEME --- */
        
        /* The container */
        .select2-container .select2-selection--single {
            height: 50px !important; /* Match input height */
            border: 1px solid var(--input-border) !important;
            border-radius: 8px !important;
            background-color: var(--input-bg) !important;
            display: flex !important;
            align-items: center !important;
        }

        /* Text inside */
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            color: var(--text-main) !important;
            font-family: var(--font-body) !important;
            font-size: 1rem !important;
            padding-left: 14px !important;
        }

        /* Focus state */
        .select2-container--open .select2-selection--single {
            border-color: var(--teal) !important;
            box-shadow: 0 0 0 4px rgba(45, 122, 117, 0.1) !important;
            background: #fff !important;
        }

        /* Arrow */
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 48px !important;
            right: 10px !important;
        }
        
        /* Dropdown */
        .select2-dropdown {
            border-color: var(--input-border) !important;
            border-radius: 8px !important;
            box-shadow: var(--shadow-card) !important;
            font-family: var(--font-body) !important;
        }

        .select2-results__option {
            padding: 12px 14px !important;
            font-size: 0.95rem !important;
        }

        /* Highlighted option matches Teal */
        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: var(--teal) !important;
        }
    </style>
</head>
<body>

    <div class="container">
        <h2>Book Appointment</h2>
        
        <div class="patient-details-box">
            <h3><span class="material-symbols-outlined" style="vertical-align:middle; font-size:18px; margin-right:5px;">person</span>Patient Details</h3>
            <p><strong>Name:</strong> <span id="displayPatientName">Loading...</span></p>
            <p><strong>Phone:</strong> <span id="displayPatientPhone">Loading...</span></p>
        </div>

        <form id="appointmentForm">
            <input type="hidden" id="patientId" name="patientId">
            <input type="hidden" id="patientName" name="patientName">
            <input type="hidden" id="gender" name="gender">
            <input type="hidden" id="age" name="age">
            <input type="hidden" id="address" name="address">
            <input type="hidden" id="phone" name="phone">

            <div class="form-group">
                <label for="doctor">Select Doctor</label>
                <select id="doctor" name="doctorId" required style="width: 100%;">
                    <option value="">Loading doctors...</option>
                </select>
            </div>

            <div class="form-group">
                <label for="date">Date & Time</label>
                <input type="datetime-local" id="date" name="date" required>
            </div>

            <div class="form-group">
                <label for="notes">Reason for Visit / Notes</label>
                <textarea id="notes" name="notes" rows="3" placeholder="Briefly describe your symptoms..."></textarea>
            </div>

            <button type="submit">
                <span class="material-symbols-outlined">check_circle</span> Confirm Booking
            </button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const patientData = JSON.parse(localStorage.getItem('patientDetails'));
            const appointmentForm = document.getElementById('appointmentForm');
            const doctorSelect = document.getElementById('doctor');
            
            // ----------------------------------------------------------------------
            // 1. AUTO-FILL PATIENT DETAILS
            // ----------------------------------------------------------------------
            if (!patientData || !patientData.patient_id) {
                alert('Please log in first to book an appointment.');
                window.location.href = 'login page.html';
                return;
            }

            document.getElementById('displayPatientName').textContent = patientData.name;
            document.getElementById('displayPatientPhone').textContent = patientData.phone;

            document.getElementById('patientId').value = patientData.patient_id;
            document.getElementById('patientName').value = patientData.name;
            document.getElementById('gender').value = patientData.gender;
            document.getElementById('age').value = patientData.age;
            document.getElementById('address').value = patientData.address;
            document.getElementById('phone').value = patientData.phone;


            // ----------------------------------------------------------------------
            // 2. FETCH AND POPULATE DOCTORS
            // ----------------------------------------------------------------------
            fetch('http://localhost:3000/api/doctors')
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`HTTP status ${res.status}`);
                    }
                    return res.json();
                })
                .then(doctors => {
                    doctorSelect.innerHTML = '<option value="">--- Select a Doctor ---</option>'; 
                    
                    if (doctors.length === 0) {
                        const option = document.createElement('option');
                        option.textContent = 'No doctors available';
                        doctorSelect.appendChild(option);
                    } else {
                        doctors.forEach(doc => {
                            const option = document.createElement('option');
                            option.value = doc.doctor_id; 
                            option.textContent = `Dr. ${doc.name} (${doc.specialization})`;
                            doctorSelect.appendChild(option);
                        });
                    }

                    // 3. Initialize the Select2 Combo Box
                    $('#doctor').select2({
                        placeholder: "Type to search name or specialty...",
                        allowClear: true,
                        width: '100%'
                    });
                })
                .catch(err => {
                    console.error('Error fetching doctors:', err);
                    doctorSelect.innerHTML = '<option value="">Failed to load doctors</option>';
                    alert('Failed to load doctor list. Check console and server status.');
                });


            // ----------------------------------------------------------------------
            // 4. APPOINTMENT SUBMISSION
            // ----------------------------------------------------------------------
            appointmentForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!$('#doctor').val()) {
                    alert("Please select a doctor.");
                    return;
                }

                const formData = new FormData(appointmentForm);
                const appointmentData = Object.fromEntries(formData.entries());
                
                appointmentData.age = parseInt(appointmentData.age);

                try {
                    const res = await fetch('http://localhost:3000/api/appointments', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(appointmentData)
                    });

                    const data = await res.json();

                    if (res.ok) {
                        alert(data.message);
                        window.location.href = 'patient-dashboard.html';
                    } else {
                        alert(`Booking Failed: ${data.message || 'Server error.'}`);
                    }

                } catch (error) {
                    console.error('Network or Server Error during booking:', error);
                    alert('Could not connect to the server. Booking failed.');
                }
            });
        });
    </script>
</body>
</html>